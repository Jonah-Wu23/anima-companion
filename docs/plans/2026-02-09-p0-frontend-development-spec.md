# Implementation Plan. Task List and Thought in Chinese — 2026-02-09 P0 Web 前端开发规范（Mobile First）

## 0. 文档定位
- 文档类型：P0 前端开发规范（设计 + 实施 + 验收）。
- 适用范围：`web/` Web/PWA 前端（手机浏览器优先，兼容桌面）。
- 对齐目标：跑通“文字对话 + 按住说话语音 + 3D 占位互动”的可用闭环，并满足可访问性与性能基线。

## 1. P0 范围与非目标

### 1.1 P0 必做（In Scope）
1. 对话 UI：消息流、输入框、发送、错误反馈、重试。
2. 语音 UI：按住说话录音、上传、转写展示、回复音频播放。
3. 3D 占位：`Idle / Listening / Thinking / Speaking / Error` 状态切换，口型能量占位。
4. 设置面板：隐私开关（是否本地保留记录）、一键清除会话数据。
5. 跨屏适配：手机浏览器优先，平板/桌面可用，不破版。
6. 基础可访问性：键盘可操作、屏幕阅读器语义、对比度与焦点可见。
7. 性能预算：首屏、交互、语音响应、3D 帧率有明确阈值。

### 1.2 P0 不做（Out of Scope）
1. 复杂直播流式（Streaming Token / Streaming Audio）先不做。
2. MMD 复杂骨骼与高阶表情系统先不做，P0 保持占位状态机。
3. 多角色同屏、多房间场景先不做。
4. 原生 App 包装与商店发布先不做（仅 PWA 可安装）。

## 2. 设计原则（高美观 + 高可用）
1. **移动端优先**：先定义 360×800 级别体验，再向上扩展。
2. **情感一致性**：视觉、文案、动效统一角色人设气质，不出现“风格断层”。
3. **信息降噪**：单屏只突出当前主任务（说/听/读），次要信息折叠到二级层。
4. **即时反馈**：任何操作 ≤ 100ms 给 UI 反馈（按压态、骨架屏、状态文案）。
5. **可恢复性**：链路失败可见、可重试、可降级到文本。
6. **低认知负担**：高频操作路径不超过 2 次点击（如“按住说话”“重试”“清除会话”）。

## 3. 方案比较与选型结论

### 3.1 备选方案
- 方案 A（推荐）：`App Router + 组件分层 + Zustand + TanStack Query + Three.js/React Three Fiber`
  - 优点：实现快、心智简单、对 P0 足够、后续可平滑扩展。
  - 缺点：需要明确状态边界，避免 store 膨胀。
- 方案 B：全量 Redux Toolkit（含异步与实体管理）
  - 优点：规范强、可追踪性高。
  - 缺点：P0 成本偏高、模板代码偏多。
- 方案 C：仅 React Context + hooks
  - 优点：最轻。
  - 缺点：异步与跨模块状态管理易分散，后期维护成本高。

### 3.2 结论
- P0 采用 **方案 A**：在不牺牲质量的前提下，获得最快落地速度与足够可维护性。

## 4. 信息架构与页面结构

### 4.1 页面层级
1. `ChatShell`（主页面容器）
2. `TopBar`（角色信息、连接状态、设置入口）
3. `Viewport3D`（3D 占位区域）
4. `MessagePanel`（消息列表 + 分段状态提示）
5. `InputDock`（文本输入 + 发送 + 按住说话）
6. `SettingsSheet`（隐私、音频、清除数据）

### 4.2 关键交互流
1. 文本对话：输入 -> `POST /v1/chat/text` -> 渲染回复 -> 可选朗读。
2. 语音对话：按住录音 -> 松开上传 `POST /v1/chat/voice` -> 展示转写 -> 播放 TTS。
3. 清除会话：设置页确认 -> `POST /v1/user/clear` -> 本地缓存清空 -> 状态重置。

## 5. 跨平台跨屏适配策略（手机浏览器优先）

### 5.1 断点与布局规则
- `xs`：`320-479`（小屏手机）——单列，3D 区域高度压缩。
- `sm`：`480-767`（常规手机）——单列，优先保证输入与语音按钮可触达。
- `md`：`768-1023`（平板）——上下结构，消息面板增高，设置面板侧滑可选。
- `lg`：`>=1024`（桌面）——双栏（左 3D / 右聊天）或居中单栏扩展宽度。

### 5.2 适配要点
1. 使用 `100dvh` + `env(safe-area-inset-*)`，规避移动端地址栏伸缩抖动。
2. 触控目标最小 `44×44`，语音主按钮建议 `56×56`。
3. 输入区固定底部时，处理软键盘顶起（避免遮挡消息末尾）。
4. 支持横竖屏切换；竖屏优先，横屏不裁剪关键按钮。
5. 渐进增强：低性能设备自动降低 3D 渲染复杂度（像素比、后处理关闭）。

### 5.3 浏览器兼容基线
- iOS Safari（近两主版本）、Android Chrome（近两主版本）、桌面 Chrome/Edge。
- 不支持特性必须优雅降级（如麦克风权限拒绝后提供文本输入兜底）。

## 6. 高美观标准（视觉与动效）

### 6.1 视觉系统
1. 设计 Token：颜色、圆角、阴影、间距、字体、层级统一变量化。
2. 风格方向：轻拟态卡片 + 半透明层次 + 柔和高对比文本。
3. 颜色对比：正文对比度至少达 WCAG AA（常规文本 4.5:1）。
4. 排版：正文最小 `14px`（移动端建议 `15-16px`），行高 `1.5-1.7`。

### 6.2 动效标准
1. 进入/退出动画 `120-220ms`，缓动一致（避免“弹窗风格不统一”）。
2. 状态动效优先“弱提示”，不可干扰输入与阅读。
3. 遵守 `prefers-reduced-motion`：关闭非关键动画，仅保留必要过渡。

## 7. 组件拆分与职责边界

### 7.1 组件清单（建议）
- `TopBar`
- `ConnectionBadge`
- `CharacterCardMini`
- `Viewport3DCanvas`
- `CharacterStateOverlay`
- `MessageList`
- `MessageItemUser`
- `MessageItemAssistant`
- `PipelineStatusChip`
- `ComposerInput`
- `PushToTalkButton`
- `PlaybackController`
- `SettingsSheet`
- `PrivacyToggle`
- `DangerZoneClearSession`

### 7.2 职责规则
1. 页面容器负责编排，不写底层请求实现。
2. `lib/api` 统一封装接口调用与错误归一化。
3. 3D 渲染与状态机逻辑在 `lib/3d`，UI 只消费状态与事件。
4. 音频采集/播放在 `lib/audio`，避免散落到按钮组件内部。
5. 每个组件必须定义“输入 props + 输出事件”，避免隐式依赖。

## 8. 状态管理设计

### 8.1 状态分层
1. **UI 瞬时态（本地）**：输入框值、弹层开关、按钮按压态。
2. **会话域状态（Zustand）**：`session_id`、消息列表、链路阶段、3D 状态、错误信息。
3. **服务端异步态（TanStack Query）**：接口请求、重试、缓存失效。
4. **持久态（LocalStorage/IndexedDB）**：隐私开关、会话 id、可选消息缓存。

### 8.2 推荐 Store 模型
- `sessionStore`：`sessionId`, `messages`, `relationship`, `memoryHint`
- `pipelineStore`：`micState`, `asrState`, `llmState`, `ttsState`, `lastError`
- `avatarStore`：`avatarState`, `lipSyncEnergy`, `emotion`
- `settingsStore`：`saveLocalHistory`, `autoPlayVoice`, `reducedMotion`

### 8.3 事件与状态同步
- 统一事件：`PRESS_TO_TALK_START`、`PRESS_TO_TALK_END`、`ASR_DONE`、`LLM_DONE`、`TTS_PLAY_START`、`TTS_PLAY_END`、`PIPELINE_ERROR`。
- 任何错误事件必须带 `stage + code + retryable`，用于 UI 精准提示。

## 9. 音视频链路（P0 实现规范）

### 9.1 接口契约（前端视角）
1. `POST /v1/chat/text`
   - 入参：`{ session_id, persona_id, user_text }`
   - 出参：`{ assistant_text, emotion, animation, relationship_delta, memory_writes }`
2. `POST /v1/chat/voice`
   - 入参：`multipart/form-data`（`audio`, `session_id`, `persona_id`, `lang?`）
   - 出参：`{ transcript_text, assistant_text, tts_media_type, tts_audio_base64, emotion, animation }`

### 9.2 语音采集与上传
1. 仅支持按住说话（P0），松开即提交。
2. 目标音频：`16kHz PCM WAV`（前端编码后上传）。
3. 权限拒绝时，给出一次性引导与文本模式兜底入口。

### 9.3 播放与同步
1. TTS 返回 base64 时转 `Blob` 播放。
2. 播放开始触发 `Speaking`，结束回到 `Idle`。
3. 用 WebAudio analyser 的能量值驱动口型占位（非精细 viseme）。

### 9.4 失败降级
1. ASR 失败：保留录音失败提示，可立刻重录。
2. LLM 失败：保留用户文本，支持“一键重试”。
3. TTS 失败：展示文本回复，不阻断对话。

## 10. 3D 占位状态机规范

### 10.1 状态定义
- `Idle`：待机呼吸。
- `Listening`：录音中，轻量发光/波纹。
- `Thinking`：等待 LLM，低频脉冲。
- `Speaking`：播放 TTS，口型能量驱动。
- `Error`：链路异常，短暂警示后可回 `Idle`。

### 10.2 转移规则
1. `Idle -> Listening`：按住说话开始。
2. `Listening -> Thinking`：松开并上传成功。
3. `Thinking -> Speaking`：收到 TTS 并开始播放。
4. `Speaking -> Idle`：播放结束。
5. `* -> Error`：任一阶段失败；`Error -> Idle` 在提示后自动恢复或用户重试。

### 10.3 开发约束
1. 状态机必须单一事实源（store），禁止组件私有状态“抢控制权”。
2. 状态切换必须可日志化（便于 QA 复盘）。
3. 首版 3D 资源不超过 1 个主角色占位体，避免性能失控。

## 11. 可访问性（A11y）要求
1. 键盘可达：输入、发送、设置、清除、重试全部可键盘操作。
2. 屏幕阅读器：关键按钮有 `aria-label`，消息列表有语义区域说明。
3. 实时反馈：ASR/LLM/TTS 过程用 `aria-live="polite"` 通知状态变化。
4. 焦点管理：弹层打开聚焦首元素，关闭后返回触发按钮。
5. 颜色与对比：文本/控件满足 WCAG 2.2 AA。
6. 动效降级：遵从 `prefers-reduced-motion`。
7. 声音可控：提供静音/自动播放开关，不强制自动播报。

## 12. 性能预算（Performance Budget）

### 12.1 体验指标（移动 4G 中端机）
- FCP ≤ `1.8s`
- LCP ≤ `2.8s`
- INP ≤ `200ms`
- CLS ≤ `0.1`
- 首次可交互（TTI）≤ `3.5s`

### 12.2 资源预算
- 首屏关键 JS（gzip）≤ `220KB`
- 首屏总资源（gzip）≤ `900KB`
- 单张纹理建议 ≤ `512KB`（P0 占位素材）
- 音频单次上传建议 ≤ `1.5MB`（控制单轮语音长度）

### 12.3 运行时预算
- 3D 渲染帧率：中端机目标 `>=30 FPS`，桌面 `>=50 FPS`
- 语音链路端到端（松手到听到首音）P50 ≤ `2.5s`，P95 ≤ `4.5s`
- 任一主线程长任务不超过 `200ms`

## 13. 测试策略

### 13.1 单元测试
1. 状态机转移测试（含错误分支）。
2. 音频工具测试（WAV 编码、播放状态事件）。
3. API 适配层测试（错误码映射、重试策略）。

### 13.2 集成测试
1. 文本对话完整链路（输入 -> 回复 -> 消息渲染）。
2. 语音链路完整流程（录音模拟 -> 上传 -> 播放 -> 状态恢复）。
3. 清除会话后本地状态与 UI 回到初始态。

### 13.3 端到端与设备回归
- 设备矩阵（至少）：
  - iPhone Safari（竖屏/横屏）
  - Android Chrome（主流分辨率）
  - Desktop Chrome/Edge
- 回归重点：
  - 麦克风权限处理
  - 输入法顶起兼容
  - 低网速和超时重试
  - 背景切换后音频恢复

## 14. 验收清单（DoD）

### 14.1 功能验收
- [ ] 文本消息发送、接收、失败重试可用。
- [ ] 按住说话流程稳定，松手后能看到转写与回复。
- [ ] TTS 播放与 3D `Speaking` 同步可观察。
- [ ] 设置面板可切换隐私选项并立即生效。
- [ ] 一键清除同时清空前端缓存与服务端会话。

### 14.2 质量验收
- [ ] 手机端主路径单手可操作，无遮挡关键控件。
- [ ] WCAG 关键条目通过（对比度、焦点、语义、键盘）。
- [ ] 性能预算满足（LCP/INP/FPS/链路时延）。
- [ ] 错误文案可理解，且提供下一步动作（重试/改文本）。

### 14.3 发布门禁
- [ ] 关键路径无 P0/P1 级阻断缺陷。
- [ ] 语音链路错误率在可接受范围（需记录样本与口径）。
- [ ] 隐私开关与数据清除行为通过验收记录。

## 15. 任务拆解（前端子任务）
1. 建立设计 Token 与基础布局骨架。
2. 完成聊天主界面与消息流组件。
3. 完成按住说话交互与音频工具封装。
4. 对接 `/v1/chat/text` 与 `/v1/chat/voice`。
5. 完成 3D 占位状态机与口型能量占位。
6. 完成设置面板、隐私开关与清除流程。
7. 落地 A11y 检查、性能埋点与预算监控。
8. 执行测试矩阵并完成验收记录。

## 16. 风险与缓解
1. **移动端权限行为差异**：建立统一权限状态机 + 首次引导。
2. **端到端时延波动**：UI 分段反馈（ASR/LLM/TTS），超时后提供重试与文本降级。
3. **3D 性能不稳**：动态降级（像素比、阴影、后处理），确保对话链路优先。
4. **状态错乱**：事件总线统一 + 单 store 单状态机 + 可观测日志。
5. **视觉不一致**：Token 化和组件级验收，禁止页面私自定义关键样式变量。

## 17. 交付物清单（P0 前端）
1. 前端开发规范文档（本文件）。
2. UI 组件清单与状态机图（可在后续补充至 `docs/architecture/client/`）。
3. 测试用例与验收记录（建议落 `docs/runbooks/release/`）。
4. 性能与可访问性检查结果（发布前附录）。

