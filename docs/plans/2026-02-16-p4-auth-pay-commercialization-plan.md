# Implementation Plan. Task List and Thought in Chinese — P4：账号体系 + 自愿打赏页 + 最小安全基线（不做 VIP 强制保护）

```
    ╔══════════════════════════════════════════════════════════════════╗
    ║                                                                  ║
    ║   ██████╗ ██████╗  ██████╗      ██╗███╗   ██╗████████╗██╗   ██╗  ║
    ║   ██╔══██╗██╔══██╗██╔═══██╗     ██║████╗  ██║╚══██╔══╝██║   ██║  ║
    ║   ██████╔╝██████╔╝██║   ██║     ██║██╔██╗ ██║   ██║   ██║   ██║  ║
    ║   ██╔═══╝ ██╔══██╗██║   ██║██   ██║██║╚██╗██║   ██║   ██║   ██║  ║
    ║   ██║     ██║  ██║╚██████╔╝╚█████╔╝██║ ╚████║   ██║   ╚██████╔╝  ║
    ║   ╚═╝     ╚═╝  ╚═╝ ╚═════╝  ╚════╝ ╚═╝  ╚═══╝   ╚═╝    ╚═════╝   ║
    ║                                                                  ║
    ║   二次元情感陪伴助手 — P4 变更版（2026-02-16）                        ║
    ║                                                                  ║
    ╚══════════════════════════════════════════════════════════════════╝
```

> 版本说明：本文件已按最新决策改版。P4 不再执行“支付核销后才可开通 VIP”的路线，改为“自愿打赏引导 + 不拦截启用”。

---

## 0. 定位与边界

### 0.1 P4 目标（本版生效）

P4 核心目标：保持当前 VIP 启用逻辑不变（用户可直接启用），新增一个“强引导打赏页”用于商业化尝试，在不增加支付闭环复杂度的前提下提升打赏转化。

- **账号体系**：用户名/手机号 + 密码/短信登录与注册（按既有计划推进）。
- **人机防护**：保留阿里云验证码 2.0（注册/登录/发短信场景）。
- **打赏页**：新增打赏页面，展示收款码与吸引性文案，主文案强调“打赏 6 元支持项目”。
- **启用逻辑**：用户点击“已打赏”后即可启用 VIP 并返回原页面；系统不做付款真实性校验。
- **安全基线**：继续做基础安全（限流、日志脱敏、CSP、安全头）。

### 0.2 明确不做（本版）

- 不做微信/支付宝官方回调支付。
- 不做订单系统、支付凭证审核、管理员核销开通。
- 不做“后端 VIP 强制鉴权拦截”（即不把 ASR/TTS/voice 作为付费门禁）。
- 不强制用户完成打赏才可启用 VIP。

### 0.3 核心产品原则

1. **自愿原则**：打赏完全自愿，不打赏也可启用。
2. **引导优先**：通过视觉和文案强化“支持项目”的意愿。
3. **最小改动**：保持现有可用路径，避免重构过多后端支付逻辑。

---

## 1. 关键用户流程（新）

### 1.1 从“启用 VIP”进入打赏页

1. 用户在原页面点击“启用 VIP”。
2. 前端先跳转到打赏页（建议路由：`/sponsor`，附带 `return_to` 参数）。
3. 打赏页展示：
   - 醒目标题（支持项目/支持白厄）
   - 推荐金额（`6 元即可支持`）
   - 微信/支付宝收款码
   - 单一主按钮：`我已打赏，启用 VIP`
4. 用户点击主按钮后：
   - 直接执行现有启用 VIP 逻辑
   - 跳回 `return_to` 页面

### 1.2 关键说明

- “我已打赏”按钮不绑定支付回调，不校验真实支付。
- 不展示“支付成功”之类具备核销含义的误导性文案。
- 页面文案需明确“自愿打赏，不影响使用”。

---

## 2. 页面与文案规范（打赏页）

### 2.1 页面信息架构

- 顶部：安全提示（认准官方收款码）。
- 主标题：高吸引力文案（例如“喜欢白厄的话，请给我们一点支持”）。
- 副标题：解释打赏用途（服务器、模型、持续更新）。
- 推荐金额卡片：`打赏 6 元即可支持我们继续更新`。
- 收款码区域：微信码 + 支付宝码 + 收款人说明。
- 主按钮：`我已打赏，启用 VIP`。
- 底部小字：`打赏为自愿行为，不影响功能使用。`

### 2.2 文案风格要求

- 目标：吸引、醒目、真诚，不恐吓、不欺骗。
- 必须避免：
  - “未付款无法使用”
  - “系统已核验付款”
  - “支付失败禁止启用”

### 2.3 与设计文档协同

- 视觉规范主文件：`docs/design/p4-ui-ux-design-spec.md`
- 本计划要求视觉 AI 在现有品牌风格上，把打赏区做成页面视觉重心（高对比、清晰层级、移动端优先）。

---

## 3. 技术方案（精简）

### 3.1 前端改造

- 新增路由：`/sponsor`
- 入参：`return_to`（默认 `/chat`）
- 行为：点击“我已打赏，启用 VIP” -> 调用现有 VIP 启用逻辑 -> `router.replace(return_to)`
- 收款码资源：使用固定静态资源（`/public` 或 CDN 固定路径）

### 3.2 后端改造

- **账号与短信相关接口**：按原计划推进。
- **支付/订单/订阅接口**：本版不实现。
- **VIP 强鉴权中间件**：本版不接入业务链路。

### 3.3 数据层改造

- MySQL 本期聚焦：用户、会话、验证码风控（如短信挑战记录、限流记录）。
- 不新增订单/订阅/支付凭证表。

### 3.4 限流存储（按你决策）

- 先用 MySQL 实现最小版限流计数。
- 维度建议：`IP`、`phone`、`account`。
- 场景：`login_password`、`login_sms`、`sms_send`、`register`。

---

## 4. 安全控制清单（保留）

### 4.1 认证安全

- 密码哈希：`argon2id`（推荐）或 `bcrypt`。
- 登录/短信前置验证码 2.0。
- 登录失败统一模糊报错，避免枚举账号。

### 4.2 Web 安全

- CSP 继续实施，限制脚本来源与第三方域名白名单。
- 安全头：`HSTS`、`X-Content-Type-Options`、`Referrer-Policy`、`Permissions-Policy`。
- 日志脱敏：手机号、验证码、token 严禁明文入日志。

### 4.3 打赏页专项

- 二维码静态资源加发布校验（至少固定文件名 + 变更审计）。
- 页面明确收款人信息，降低误付风险。

---

## 5. 执行分工（更新版）

| 模块 | 交付物 | 执行者 |
|---|---|---|
| 打赏页视觉与文案 | 强引导页面设计、移动端样式、文案规范 | 强视觉AI |
| 启用VIP跳转流程 | `启用VIP -> /sponsor -> 已打赏按钮 -> 返回` | 强逻辑AI |
| 账号与会话 | 注册/登录/短信验证码/Cookie Session | 强逻辑AI |
| 限流与日志脱敏 | MySQL 最小限流表 + 脱敏规则 | 强逻辑AI |
| CSP/安全头 | 最小安全基线落地 | 强逻辑AI |

---

## 6. Phase 任务拆解（更新版）

### Phase A：口径冻结（0.5 工作单元）

- [ ] 确认“打赏自愿，不校验支付”文案为最终口径。
- [ ] 确认打赏页路由命名：`/sponsor`（或沿用 `/pay` 但语义改为打赏）。

### Phase B：账号与风控基线（1-2 工作单元）

- [ ] 接入 MySQL（用户/会话/短信挑战/限流记录）。
- [ ] 完成注册/登录/短信发送与校验。
- [ ] 完成验证码 2.0 服务端校验。

### Phase C：打赏页落地（1 工作单元）

- [ ] 新增打赏页 UI（高吸引力文案 + 收款码 + 单按钮）。
- [ ] 打通 `return_to` 回跳。

### Phase D：启用 VIP 流程改造（0.5 工作单元）

- [ ] 把原“启用 VIP”入口统一改为先跳打赏页。
- [ ] 点击“我已打赏，启用 VIP”后执行原启用逻辑。

### Phase E：安全与回归（0.5-1 工作单元）

- [ ] 回归注册/登录/短信限流。
- [ ] 回归打赏页跳转与回跳。
- [ ] 检查文案不存在“已核销支付”等误导表达。

---

## 7. 验收标准（Checklist）

- [ ] 用户点击“启用 VIP”会先进入打赏页。
- [ ] 打赏页只有一个主行为按钮：`我已打赏，启用 VIP`。
- [ ] 用户即使未实际打赏，点击按钮也能启用 VIP 并返回原页面。
- [ ] 页面醒目展示“打赏 6 元即可支持”。
- [ ] 页面同时明确“打赏自愿，不影响使用”。
- [ ] 登录/注册/短信链路仍受验证码与限流保护。
- [ ] 日志无手机号全量、验证码、token 明文。

---

## 8. 历史方案处置说明

以下文档作为历史参考，当前 P4 不执行其“支付闭环与 VIP 强鉴权”内容：

- `docs/design/p4-auth-pay-backend-spec.md`

如后续决定恢复“付费后开通”的商业模式，再基于该文档重启订单/订阅/核销链路。
