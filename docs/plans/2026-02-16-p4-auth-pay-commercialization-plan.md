# Implementation Plan. Task List and Thought in Chinese — P4：账号体系 + 支付页(二维码人工核对) + VIP后端鉴权 + 安全基线

```
    ╔══════════════════════════════════════════════════════════════════╗
    ║                                                                  ║
    ║   ██████╗ ██████╗  ██████╗      ██╗███╗   ██╗████████╗██╗   ██╗  ║
    ║   ██╔══██╗██╔══██╗██╔═══██╗     ██║████╗  ██║╚══██╔══╝██║   ██║  ║
    ║   ██████╔╝██████╔╝██║   ██║     ██║██╔██╗ ██║   ██║   ██║   ██║  ║
    ║   ██╔═══╝ ██╔══██╗██║   ██║██   ██║██║╚██╗██║   ██║   ██║   ██║  ║
    ║   ██║     ██║  ██║╚██████╔╝╚█████╔╝██║ ╚████║   ██║   ╚██████╔╝  ║
    ║   ╚═╝     ╚═╝  ╚═╝ ╚═════╝  ╚════╝ ╚═╝  ╚═══╝   ╚═╝    ╚═════╝   ║
    ║                                                                  ║
    ║   白厄 陪伴助手 — 商业化与安全基建阶段 (2026-02-16)               ║
    ║                                                                  ║
    ╚══════════════════════════════════════════════════════════════════╝
```

> 重要声明（合规边界）：本文档是工程实现计划，不构成法律/财税建议。涉及《电商法》等条款与“无需登记情形”的表述，必须以你最终自行核对的官方文本和/或律师意见为准；计划中只把“公示位点、内容结构、可回溯证据”写清，不替代合规判断。

---

## 0. 定位与边界

### 0.1 P4 做什么

P4 的核心目标：把 P3 的“前端门控体验”升级为“后端可防绕过的账号-权限-支付闭环”，并新增 4 个网页（新主页/登录/注册/支付），同时满足最基本的网络安全与支付链路安全。

- **账号体系**：用户名+密码注册/登录；手机号+短信验证码注册/登录；绑定与找回密码（可选）。
- **人机防护**：接入 **阿里云验证码2.0**（客户端取 `captchaVerifyParam`，服务端调用 `VerifyIntelligentCaptcha` 校验）。
- **短信验证码**：接入 **阿里云短信认证（Dypnsapi）** 的发送与校验（个人开发者免签名模板模式）。
- **支付路线 A**：网站展示微信/支付宝收款码 + 用户提交支付凭证 + **人工核对** + 手工发货/开通（不做自动回调）。
- **VIP 后端鉴权**：把 VIP 校验下沉到后端中间件/依赖项，保护 ASR/TTS/语音链路等接口，防止绕过前端直接调用。
- **订阅状态持久化**：MySQL（宝塔面板）落库，包含订阅状态、过期时间、订单与审计日志的最小集合。
- **新页面**：
  - **真正的主页**：产品介绍 + 操作教程 + 风险提示 + 登录/开始使用入口
  - **登录页**
  - **注册页**
  - **支付页**（二维码 + 下单/备注指引 + 凭证提交/状态展示）

### 0.2 P4 不做什么（刻意不做，保持 KISS）

- 不接入微信/支付宝官方支付 API（不做异步回调、分账、自动发货）。
- 不做复杂的会员体系（多等级权益、券、返利、复杂账单）。
- 不做企业级风控（设备指纹、黑名单画像、复杂反欺诈策略）。
- 不把 P3 的聊天/记忆 SQLite 全量迁移到 MySQL（本期只把账号/订阅/订单落到 MySQL；其余可后续再迁）。

### 0.3 现状基线（P3 结束时）

- 前端：`web/src/app/page.tsx` 目前就是“对话主界面”（并非 landing page）。
- 后端：`server/app/api/v1/endpoints/user.py` 只有 `POST /v1/user/clear`，没有账号体系。
- 会话/记忆：当前以 SQLite 存储（`server/app/repositories/session_store.py`）。
- P3 明确留给 P4 的内容：**VIP 后端鉴权与充值系统、订阅状态持久化与过期机制**（见 P3 文档 0.2）。

---

## 1. 构思方案（先定口径，再拆任务）

### 1.1 支付路线确认（你已选择：路线 A）

**路线 A（推荐，已选）**：二维码收款 + 人工核对 + 人工发货/开通。

优势：
- 工程复杂度低，支付安全面最小（不接触支付密钥/回调）。
- 上线最快，适合验证商业闭环。

核心风险与补救（P4 必须做）：
- **二维码被篡改**（XSS/静态资源被替换/供应链）：用 CSP、静态资源不可变、最小化第三方脚本、部署层防篡改。
- **伪造付款**（截图造假/PS）：订单号+金额+备注规则+人工核对口径+审计留痕。
- **越权开通**（绕过前端直接调用开通接口）：后端只允许管理员通道改变订阅状态；普通用户只能“发起申请/提交凭证”。

### 1.2 身份与会话方案（给出 3 选 1，默认选 A）

A. **同域 Cookie Session（推荐）**
- 生产部署时通过 Nginx/宝塔把 Next 与 FastAPI 放在同一主域名下（路径转发），后端签发 `HttpOnly` + `Secure` + `SameSite=Lax` cookie。
- 好处：前端不存 token，抗 XSS 更强；对“二维码不可被篡改”的安全诉求更友好。
- 代价：本地开发需要处理跨端口 cookie 或走 BFF（可在 P4 里用最小方案解决）。

B. Bearer JWT（仅开发期可用）
- 前端持有 access token（内存而不是 localStorage），刷新策略另议。
- 好处：CORS 简单。
- 代价：XSS 风险更高；且你强调支付链路安全，不推荐长期采用。

C. Next.js BFF（中期演进）
- 浏览器只请求 Next 内部 `/api/*`，Next 再转发到 FastAPI（或把账号逻辑直接放在 Next）。
- 好处：前端与后端边界更可控，CORS/CSRF 简化。
- 代价：实现路径更多，和现有 FastAPI 架构拆分要谨慎。

**P4 默认采用 A（同域 Cookie Session）**；开发期允许临时走 B，但必须写清最终部署口径。

### 1.3 VIP 商品口径冻结（你已选择：选项 A）

- `plan_code`：`vip_monthly`
- 时长：固定 30 天（`expires_at = starts_at + 30 days`）
- 续费：仍走路线 A（二维码 + 人工核对），不做自动续费
- 价格：`amount_cny = 6.00`（元/月，本期计划按“可配置常量”实现，避免写死在多处）

---

## 2. 威胁模型与安全基线（“最基本安全防护”的明确清单）

### 2.1 必防攻击面（按优先级）

- **账号安全**：撞库/爆破、弱口令、验证码绕过、短信轰炸、会话固定/劫持。
- **支付链路**：二维码篡改、伪造支付凭证、越权开通 VIP、订单状态篡改。
- **Web 常见漏洞**：XSS（会导致二维码被替换）、CSRF（会导致用户被动下单/绑手机）、SQL 注入、文件上传滥用、越权访问（IDOR）。
- **供应链与配置泄漏**：前端构建产物被污染、`.env`/AccessKey 泄漏、日志泄漏手机号。

### 2.2 安全基线（P4 交付必须满足）

- **账号**
  - 密码只存**强哈希**（`argon2id` 或 `bcrypt`），带盐；禁止明文与可逆加密。
  - 登录/注册/发短信都必须先通过 **阿里云验证码2.0**（或在某些场景至少其一）。
  - 关键接口限流：按 `IP + 账号 + 手机号` 维度限流；错误次数指数退避；返回统一错误文案（避免枚举）。
  - 会话：短期 access cookie + 可选 refresh；登录成功后 rotate session；登出时废止。

- **支付**
  - 支付页展示的二维码资源必须“部署不可篡改”：静态资源走只读发布；加完整性校验（哈希记录）与变更审计。
  - **普通用户无法直接写订阅状态**：只能创建订单/提交凭证；“标记已支付/开通订阅”只能走管理员通道。
  - 订单与订阅变更必须记录 **审计日志**：谁在什么时间对哪个订单/订阅做了什么。

- **Web**
  - CSP（内容安全策略）必须落地，至少约束 `script-src`，把第三方域名白名单显式化（阿里云验证码脚本域名）。
  - 反 CSRF：对 cookie 会话要有 CSRF token 或双重提交 cookie（按实现选其一）。
  - 输入校验与输出编码：严禁把用户输入插进 `dangerouslySetInnerHTML`。
  - 后端参数化查询（ORM/SQL 参数化），避免拼 SQL。

- **密钥与日志**
  - AccessKey 只放服务端环境变量/宝塔面板安全配置，且使用 RAM 子账号最小权限。
  - 日志脱敏：手机号、captcha 参数、短信验证码不得落日志；支付凭证只保留必要字段。

---

## 3. 总体架构与数据流（组件级）

### 3.1 组件

- `web/`：Next.js（App Router）负责 UI、路由、静态页、操作教程、登录/注册/支付页。
- `server/`：FastAPI 负责账号、验证码校验、短信校验、订单、订阅与 VIP 鉴权中间件。
- MySQL（宝塔面板）：存用户、订阅、订单、审计日志（本期最小落库）。
- 阿里云：
  - Captcha 2.0：前端拿 `captchaVerifyParam`，后端 VerifyIntelligentCaptcha 校验。
  - 短信认证：SendSmsVerifyCode/CheckSmsVerifyCode。

### 3.2 关键数据流（高层）

1. 注册/登录时：浏览器完成阿里云验证码交互 -> 产生 `captchaVerifyParam` -> 调用后端注册/登录接口 -> 后端先验 captcha -> 再做短信校验（如需要）-> 创建/更新用户 -> 发会话 cookie。
2. 支付：用户创建订单 -> 支付页展示二维码与“付款备注规则” -> 用户提交支付凭证（最小字段）-> 状态变为“待人工核对” -> 管理员人工核对后开通订阅。
3. VIP 调用：前端请求语音/对话相关后端接口 -> 后端中间件读取会话 -> 查询订阅是否有效 -> 通过/拒绝（返回明确错误码供前端弹 VIP 提示）。

---

## 4. 数据模型（MySQL，最小可用 + 可审计）

> 目标：不追求完美，只要“可用、可回溯、可扩展、不易被绕过”。

### 4.1 表清单（建议）

- `users`
  - `id`（PK, bigint）
  - `username`（unique, 可选）
  - `phone`（unique, 可选）
  - `password_hash`（nullable，允许短信登录用户后补设密码）
  - `created_at`, `updated_at`, `last_login_at`
  - `status`（active/locked/deleted）

- `auth_sessions`
  - `id`（PK）
  - `user_id`（FK）
  - `session_token_hash`（只存 hash，不存明文 token）
  - `expires_at`, `created_at`, `revoked_at`
  - `ip`, `user_agent_hash`

- `subscriptions`
  - `id`（PK）
  - `user_id`（FK）
  - `plan_code`（固定：`vip_monthly`）
  - `status`（active/expired/canceled/pending）
  - `starts_at`, `expires_at`
  - `source_order_id`（nullable）

- `orders`
  - `id`（PK）
  - `user_id`（FK）
  - `order_no`（unique，展示给用户）
  - `plan_code`（固定：`vip_monthly`）
  - `amount_cny`（decimal，来自服务端配置常量）
  - `status`（created/pending_review/paid/rejected/canceled）
  - `pay_channel`（wechat/alipay）
  - `created_at`, `updated_at`

- `payment_proofs`（如你决定接收截图/流水号）
  - `id`（PK）
  - `order_id`（FK）
  - `type`（screenshot/txn_id/text）
  - `storage_url`（如上传 OSS；若不上传则存文本字段）
  - `note`（用户备注）
  - `created_at`

- `audit_logs`
  - `id`（PK）
  - `actor_user_id`（nullable；管理员可用 0 或单独标识）
  - `action`（如 `ORDER_CREATE` / `ORDER_MARK_PAID` / `SUBSCRIPTION_GRANT`）
  - `target_type`, `target_id`
  - `ip`, `ua_hash`
  - `detail_json`
  - `created_at`

### 4.2 数据最小化与隐私

- `phone` 属于 PII：只在必要场景显示部分脱敏；后台操作也尽量脱敏。
- 支付凭证尽量不收集截图（截图=高风险 PII/交易信息），优先收集“订单号+付款备注+金额+大致时间”，人工在收款后台核对。

---

## 5. 接口设计（FastAPI v1，按“可控/可审计/可限流”组织）

> 注意：以下是“计划接口”，具体 path 可在实现时微调，但必须保证“普通用户无法写订阅状态”。

### 5.1 Captcha 校验（内聚在业务接口里）

- `POST /v1/auth/register`
- `POST /v1/auth/login/password`
- `POST /v1/auth/login/sms`
- `POST /v1/auth/sms/send`

统一要求：携带 `captcha_verify_param`，后端先调用阿里云 `VerifyIntelligentCaptcha`，通过才进入下一步。

### 5.2 短信验证码

- `POST /v1/auth/sms/send`
  - 输入：`phone`、用途（register/login/reset）、`captcha_verify_param`
  - 行为：限流 + 调用 SendSmsVerifyCode

- `POST /v1/auth/login/sms`
  - 输入：`phone`、`verify_code`、`captcha_verify_param`
  - 行为：调用 CheckSmsVerifyCode -> 登录成功签发会话

### 5.3 账号与会话

- `POST /v1/auth/register`
  - 支持两种注册：
    - 手机号+短信验证码（强推荐）
    - 用户名+密码（也可，但建议仍要求手机号绑定以便找回）

- `POST /v1/auth/login/password`
- `POST /v1/auth/logout`
- `GET /v1/auth/me`（返回登录态、基础信息、订阅状态快照）

### 5.4 订单与订阅

- `POST /v1/orders/create`
  - 输入：`plan_code`、`pay_channel`
  - 输出：`order_no`、`amount`、展示文案（含“付款备注规则”）

- `POST /v1/orders/submit-proof`
  - 输入：`order_no` + 最小凭证信息
  - 输出：订单状态

- `GET /v1/subscription/status`
  - 输出：是否 VIP、到期时间、权益（用于前端门控与展示）

### 5.5 管理员通道（最小攻击面优先）

两种方案（推荐 A）：

A. **离线脚本/运维命令（推荐）**
- 由你在服务器上运行管理脚本：按 `order_no` 标记 `paid` 并开通订阅。
- 好处：不暴露 admin web 面。

B. **管理 API（谨慎）**
- `POST /v1/admin/orders/mark-paid`
- `POST /v1/admin/subscriptions/grant`
- 保护：仅允许内网/固定 IP + 强鉴权（独立 admin token）+ 审计日志。

---

## 6. 页面与路由规划（Next.js App Router）

### 6.1 路由列表（P4 新增/改造）

- `/`：**新主页**（产品介绍 + 操作教程 + 风险与隐私说明 + CTA：登录/注册/开始）
- `/login`：登录（密码登录 + 短信登录，两种 Tab）
- `/register`：注册（手机号/短信为主，用户名密码可选）
- `/pay`：支付（展示二维码 + 下单/备注指引 + 提交凭证 + 状态）

建议保留现有“对话主界面”到新路径：
- `/chat`：原 `web/src/app/page.tsx` 内容迁移过来（P4 计划中只描述，不在本期提前实现以外的重构）

### 6.2 UI/UX 关键要求（支付安全优先）

- 支付页必须显式提示：
  - “本站不自动发货，需人工核对”
  - “请按订单号备注付款，否则可能延迟”
  - “不要在聊天中发送身份证/银行卡等敏感信息”
- 主页必须有“操作教程”（新手三步）：
  - 注册/登录
  - 进入对话页开始互动
  - VIP 与支付说明（路线 A）

### 6.3 公示与页脚

- 页脚或关于区域包含：
  - 联系方式（至少一种可触达渠道）
  - 业务说明与退款/交付口径（简短、明确、可执行）
  - 你希望展示的“《电商法》第10条零星小额交易活动”等说明的占位（**必须在上线前由你确认文本准确性**）
- `qrcode.png` 的使用：建议作为支付页展示资产之一，但**同时**在页面以文字形式公示关键信息（避免“图片里写字不可检索/不可版本化”）。

---

## 7. 执行分工（强视觉AI / 强逻辑AI：协同但不混做）

### 7.1 模块拆分表

| 模块 | 交付物 | 执行者 |
|---|---|---|
| 新主页信息架构 | 教程内容结构、信息层级、文案草案 | 强视觉AI |
| 新主页视觉设计 | 版式、动效、插画/背景、CTA | 强视觉AI |
| 登录/注册/支付页 UI | 组件、状态、错误提示、无障碍 | 强视觉AI |
| 身份与会话架构 | cookie/session/JWT 选型、CSRF、防爆破 | 强逻辑AI |
| MySQL 数据模型 | 表结构、迁移策略、最小审计日志 | 强逻辑AI |
| Captcha 2.0 服务端校验 | VerifyIntelligentCaptcha 封装、错误码映射 | 强逻辑AI |
| 短信认证接入 | 发送/校验、限流、重放防护 | 强逻辑AI |
| 订单/订阅系统 | create/submit-proof/admin-grant | 强逻辑AI |
| VIP 后端鉴权 | 中间件/依赖项保护 ASR/TTS/voice | 强逻辑AI |
| 安全 Header/CSP | CSP 方案、第三方脚本白名单 | 强逻辑AI（视觉AI配合避免内联脚本） |

### 7.2 强视觉AI 任务书（可直接复制作为“强视觉AI提示词”）

目标：为 P4 新增 4 个页面做“高可信、强引导、支付安全优先”的视觉与交互设计，不做代码实现，只输出结构化设计规范。

输出要求：
- 页面清单：`/`、`/login`、`/register`、`/pay`（并考虑 `/chat` 的入口按钮与引导）。
- 每页必须给出：
  - 信息架构（模块顺序、标题、关键文案）
  - 关键交互状态（loading/disabled/error/success）
  - 错误提示文案（避免泄露账号是否存在）
  - 移动端布局优先（PWA）
  - “支付安全提示”与“隐私提示”的位置与风格（必须醒目但不恐吓）
- 视觉风格要求：
  - 与现有 3D/相册风格一致，但更“官网化”
  - 避免过度花哨影响可信度；支付页以清晰为主
- 产物格式：
  - 1 份 markdown：每页一个 section
  - 可选：提供配色/字体变量建议（CSS variables）

### 7.3 强逻辑AI 任务书（可直接复制作为“强逻辑AI提示词”）

目标：在 FastAPI + MySQL 上实现“账号+验证码+短信+订单+订阅+VIP鉴权”的最小闭环，并确保支付链路不可被普通用户绕过。

输出要求：
- 数据库表设计（字段、索引、唯一性、审计日志）。
- 接口列表与请求/响应 schema（含错误码语义，前端可据此弹窗）。
- 安全控制清单：
  - 密码哈希算法与参数
  - 限流策略（维度/阈值/退避）
  - CSRF 策略（若使用 cookie）
  - 日志脱敏规则
  - 权限边界：普通用户 vs 管理员
- 订单与订阅状态机（允许的状态迁移）。
- 关键威胁对应的防护点（二维码篡改、伪造支付、越权开通）。

---

## 8. P4 任务拆解（Phase 化推进，带验收标准）

### Phase 0：疑点澄清与口径冻结（预计 0.5 工作单元）

**主执行**：强逻辑AI（你拍板）

- 决策点：
  - VIP 商品已冻结：`vip_monthly`（30 天），仍需确认 `amount_cny` 与权益边界（哪些接口算 VIP）。
  - 注册是否强制绑定手机号？（推荐：是）
  - 支付凭证是否收截图？（推荐：否，或可选但默认不收）
  - 生产部署是否能做到同域（推荐：是，走 cookie session）

**验收标准**：
- [ ] 输出一份“口径冻结”小节（写入本计划文档的最终版）

### Phase A：MySQL 接入与最小表结构（预计 1 工作单元）

**主执行**：强逻辑AI

- 建表：`users`、`auth_sessions`、`orders`、`subscriptions`、`audit_logs`
- 迁移策略：本期只新增，不迁移现有 SQLite 聊天/记忆数据

**验收标准**：
- [ ] 本地可连接 MySQL（dev 用 .env；prod 用宝塔面板连接串）
- [ ] 表结构可创建并通过最小增删改查验证

### Phase B：会话与鉴权（预计 1 工作单元）

**主执行**：强逻辑AI

- 登录成功签发会话（推荐 cookie）
- `GET /v1/auth/me` 能返回登录态
- 限流与统一错误返回

**验收标准**：
- [ ] 密码只存 hash
- [ ] 登录态不可伪造（token 随机、可撤销、过期可控）

### Phase C：阿里云验证码2.0（预计 1 工作单元）

**主执行**：强逻辑AI（服务端） + 强视觉AI（前端嵌入不破坏 UI）

- 前端：加载 AliyunCaptcha JS，拿到 `captchaVerifyParam`
- 后端：封装 VerifyIntelligentCaptcha；错误码映射（统一对外错误文案）

**验收标准**：
- [ ] 没通过验证码无法注册/登录/发短信
- [ ] 不把 `captchaVerifyParam` 写入日志

### Phase D：短信认证（预计 1 工作单元）

**主执行**：强逻辑AI

- 发送验证码：限流 + 防滥用 + 失败不泄露细节
- 核验验证码：成功则创建/登录用户

**验收标准**：
- [ ] 同手机号/同 IP 触发频率受控
- [ ] 验证码错误不会暴露“手机号是否已注册”

### Phase E：订单/支付页（路线 A）与人工核对链路（预计 1-2 工作单元）

**主执行**：强逻辑AI（状态机与审计） + 强视觉AI（支付页信息可信）

- 订单创建：生成 `order_no`，明确金额与备注规则
- 提交凭证：进入 `pending_review`
- 管理员开通：推荐离线脚本；必须写 audit log

**验收标准**：
- [ ] 普通用户无法把订单改为 paid
- [ ] 普通用户无法直接开通订阅
- [ ] 全链路有审计日志可追溯

### Phase F：VIP 后端鉴权与前端门控联动（预计 1 工作单元）

**主执行**：强逻辑AI

- 在语音相关接口处加依赖校验（订阅有效才放行）
- 前端拿错误码弹 VIP 提示并引导到 `/pay`

**验收标准**：
- [ ] 绕过前端直接调用后端接口会被拒绝
- [ ] 订阅过期后自动失效

### Phase G：新主页/登录/注册 UI 落地（预计 1-2 工作单元）

**主执行**：强视觉AI（主） + 强逻辑AI（接口对接）

- 新主页包含操作教程与支付说明
- 登录/注册页支持 captcha + 短信/密码
- 支付页展示二维码与状态

**验收标准**：
- [ ] 4 个页面可访问且移动端可用
- [ ] 文案与错误提示不泄露敏感信息

### Phase H：上线安全清单与回归（预计 0.5-1 工作单元）

**主执行**：强逻辑AI

- 生产环境：HTTPS、HSTS、CSP、安全头、日志脱敏、RAM 最小权限、备份策略
- 回归：注册/登录/支付申请/管理员开通/VIP鉴权/订阅过期

**验收标准**：
- [ ] 关键链路全回归通过
- [ ] 安全基线 checklist 全部打勾

---

## 9. 验收用例（Checklist）

- 注册
  - [ ] captcha 通过才能发短信
  - [ ] 短信码错误不泄露账号存在性
  - [ ] 密码哈希可验证且参数合理

- 登录
  - [ ] 密码爆破被限流
  - [ ] 短信轰炸被限流
  - [ ] 会话可撤销/过期

- 支付
  - [ ] 生成订单号与金额一致
  - [ ] `vip_monthly` 的到期时间为开通后 30 天（精确到秒/时区口径固定）
  - [ ] 提交凭证进入待审核
  - [ ] 非管理员无法开通 VIP
  - [ ] 管理操作有审计日志

- VIP 鉴权
  - [ ] 非 VIP 调用语音接口被拒绝并返回可识别错误码
  - [ ] VIP 到期后立即失效

- 安全
  - [ ] CSP 生效且不影响阿里云验证码
  - [ ] 日志无手机号/验证码/支付敏感信息

---

## 10. 待你确认的 1 个关键问题（影响表结构与支付页）

已按你选择冻结：**选项 A（`vip_monthly` 固定 30 天）**。

并已冻结价格参数（会写入服务端配置常量，并展示在支付页）：

`vip_monthly`：`amount_cny = 6.00`（元/月）
